---
import {
  languages,
  getLangFromUrl,
  getAlternateLanguageUrl,
  type Language,
} from "../i18n";

const currentLang = getLangFromUrl(Astro.url);
---

<details class="relative language-switcher group">
  <summary
    class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-cream-200 dark:hover:bg-dark-700 transition-colors text-dark-600 dark:text-dark-300 cursor-pointer list-none"
  >
    <svg
      class="w-5 h-5"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"
      ></path>
    </svg>
    <span class="text-sm font-medium uppercase">{currentLang}</span>
    <svg
      class="w-4 h-4 transition-transform group-open:rotate-180"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M19 9l-7 7-7-7"></path>
    </svg>
  </summary>

  <div
    class="absolute right-0 top-full mt-2 py-2 w-50 bg-white dark:bg-dark-800 rounded-xl shadow-lg border border-cream-200 dark:border-dark-700 z-50"
  >
    {
      Object.entries(languages).map(([lang, label]) => (
        <a
          href={getAlternateLanguageUrl(Astro.url, lang as Language)}
          data-lang={lang}
          class:list={[
            "flex items-center gap-3 px-4 py-2 text-sm transition-colors",
            currentLang === lang
              ? "bg-slice-50 dark:bg-slice-900/30 text-slice-700 dark:text-slice-400 font-medium"
              : "text-dark-600 dark:text-dark-300 hover:bg-cream-50 dark:hover:bg-dark-700 hover:text-dark-900 dark:hover:text-cream-100",
          ]}
        >
          <span class="w-6 text-center uppercase font-mono text-xs">
            {lang}
          </span>
          <span>{label}</span>
          {currentLang === lang && (
            <svg
              class="w-4 h-4 ml-auto text-slice-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 13l4 4L19 7"
              />
            </svg>
          )}
        </a>
      ))
    }
  </div>
</details>

<script>
  // Progressive enhancement: chỉ enhance animation, không thay đổi functionality
  // <details> đã hoạt động tốt mà không cần JS

  // Lưu ngôn ngữ vào cookie khi chọn
  const langLinks = document.querySelectorAll("[data-lang]");
  langLinks.forEach((link) => {
    link.addEventListener("click", (e) => {
      const lang = (e.currentTarget as HTMLElement).getAttribute("data-lang");
      if (lang) {
        // Lưu vào cookie để middleware có thể đọc
        const expiryDate = new Date();
        expiryDate.setFullYear(expiryDate.getFullYear() + 1); // Cookie hết hạn sau 1 năm
        document.cookie = `preferred-language=${lang}; expires=${expiryDate.toUTCString()}; path=/; SameSite=Lax`;
      }
    });
  });

  // Đóng dropdown khi click bên ngoài (enhancement)
  document.addEventListener("click", (e) => {
    const target = e.target as HTMLElement;
    const details = target.closest(".language-switcher") as HTMLDetailsElement;
    if (!details) {
      // Đóng tất cả language switcher khi click bên ngoài
      document.querySelectorAll(".language-switcher").forEach((el) => {
        (el as HTMLDetailsElement).open = false;
      });
    }
  });
</script>
