---
import { Icon } from "astro-icon/components";
---

<button
  id="theme-toggle"
  type="button"
  class="relative w-10 h-10 rounded-xl bg-cream-200 dark:bg-dark-700 hover:bg-cream-300 dark:hover:bg-dark-600 transition-all duration-300 flex items-center justify-center group"
  aria-label="Toggle dark mode"
>
  <Icon
    id="sun-icon"
    name="heroicons:sun"
    class="w-5 h-5 text-slice-500 transition-all duration-300 absolute opacity-100 dark:opacity-0 dark:rotate-90 rotate-0"
  />
  <Icon
    id="moon-icon"
    name="heroicons:moon"
    class="w-5 h-5 text-slice-400 transition-all duration-300 absolute opacity-0 dark:opacity-100 -rotate-90 dark:rotate-0"
  />
</button>

<script>
  function initThemeToggle() {
    const themeToggle = document.getElementById("theme-toggle");
    if (!themeToggle) return;

    // Remove existing listeners by cloning the button
    const newToggle = themeToggle.cloneNode(true);
    themeToggle.parentNode?.replaceChild(newToggle, themeToggle);

    newToggle.addEventListener("click", () => {
      const currentTheme = document.documentElement.classList.contains("dark")
        ? "dark"
        : "light";
      const newTheme = currentTheme === "dark" ? "light" : "dark";

      // Function to set theme
      // @ts-ignore
      const setTheme = (theme) => {
        if (theme === "dark") {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }
        localStorage.setItem("theme", theme);
      };

      // Use View Transitions API if available for smooth theme transition
      if (typeof document.startViewTransition === "function") {
        document.startViewTransition(() => {
          setTheme(newTheme);
        });
      } else {
        setTheme(newTheme);
      }
    });
  }

  // Function to restore theme from localStorage
  function restoreTheme() {
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme) {
      if (savedTheme === "dark") {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
    }
  }

  // Initialize on DOM ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      restoreTheme();
      initThemeToggle();
    });
  } else {
    restoreTheme();
    initThemeToggle();
  }

  // Re-initialize and restore theme after view transitions
  document.addEventListener("astro:page-load", () => {
    restoreTheme();
    initThemeToggle();
  });
</script>
