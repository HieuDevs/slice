---
import Layout from "../../layouts/Layout.astro";
import { Icon } from "astro-icon/components";
import {
  languages,
  useTranslations,
  getLocalizedPath,
  type Language,
} from "@/i18n";

export const prerender = false;

const { lang } = Astro.params as { lang: Language };
const t = useTranslations(lang);
---

<Layout
  title={`${t("login.title")} - Slice`}
  currentPath={getLocalizedPath("/login", lang)}
  lang={lang}
>
  <section
    class="min-h-screen flex items-center justify-center py-24 bg-linear-to-br from-cream-50 to-cream-100 dark:from-dark-950 dark:to-dark-900"
  >
    <div class="max-w-md w-full mx-4">
      <div
        class="card p-8 opacity-0 animate-fade-in"
        style="animation-delay: 200ms"
      >
        <!-- Logo -->
        <div class="flex justify-center mb-8">
          <a href={getLocalizedPath("/", lang)} class="flex items-center gap-3">
            <div
              class="w-12 h-12 bg-linear-to-br from-slice-400 to-slice-600 rounded-xl flex items-center justify-center shadow-glow"
            >
              <Icon name="heroicons:cube" class="w-7 h-7 text-white" />
            </div>
            <span
              class="font-display text-2xl font-bold text-dark-900 dark:text-cream-100"
              >Slice</span
            >
          </a>
        </div>

        <!-- Title -->
        <div class="text-center mb-8">
          <h1
            class="text-3xl font-display font-bold text-dark-900 dark:text-cream-100 mb-2"
          >
            {t("login.title")}
          </h1>
          <p class="text-dark-600 dark:text-dark-300">
            {t("login.subtitle")}
          </p>
        </div>

        <!-- Error Message -->
        <div
          id="error-message"
          class="hidden mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl"
        >
          <p class="text-red-600 dark:text-red-400 text-sm text-center">
            {t("login.error")}
          </p>
        </div>

        <!-- Login Form -->
        <form id="login-form" class="space-y-6">
          <!-- Username Field -->
          <div>
            <label
              for="username"
              class="block text-sm font-medium text-dark-700 dark:text-dark-200 mb-2"
            >
              {t("login.username")}
            </label>
            <input
              type="text"
              id="username"
              name="username"
              required
              class="w-full px-4 py-3 rounded-xl border border-cream-300 dark:border-dark-700 bg-white dark:bg-dark-800 text-dark-900 dark:text-cream-100 focus:outline-none focus:ring-2 focus:ring-slice-500 dark:focus:ring-slice-400 transition-all"
              placeholder={t("login.username")}
            />
          </div>

          <!-- Password Field -->
          <div>
            <label
              for="password"
              class="block text-sm font-medium text-dark-700 dark:text-dark-200 mb-2"
            >
              {t("login.password")}
            </label>
            <input
              type="password"
              id="password"
              name="password"
              required
              class="w-full px-4 py-3 rounded-xl border border-cream-300 dark:border-dark-700 bg-white dark:bg-dark-800 text-dark-900 dark:text-cream-100 focus:outline-none focus:ring-2 focus:ring-slice-500 dark:focus:ring-slice-400 transition-all"
              placeholder={t("login.password")}
            />
          </div>

          <!-- Submit Button -->
          <button type="submit" class="w-full btn-primary justify-center">
            {t("login.submit")}
            <Icon name="heroicons:arrow-right" class="w-5 h-5 ml-2" />
          </button>
        </form>
      </div>
    </div>
  </section>
</Layout>

<script define:vars={{ lang }}>
  const loginForm = document.getElementById("login-form");
  const errorMessage = document.getElementById("error-message");
  const submitBtn = loginForm?.querySelector('button[type="submit"]');

  loginForm?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;

    // Disable submit button
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = "Logging in...";
    }

    try {
      const response = await fetch("/api/auth/login", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ username, password }),
      });

      const data = await response.json();

      if (response.ok && data.success) {
        // Success - store JWT token in cookie and localStorage
        if (data.token) {
          localStorage.setItem("token", data.token);
          const expiryDate = new Date();
          expiryDate.setTime(expiryDate.getTime() + 24 * 60 * 60 * 1000);
          document.cookie = `token=${data.token}; path=/; expires=${expiryDate.toUTCString()}; SameSite=Lax`;
        }

        // Set authentication state in localStorage for client-side checks
        localStorage.setItem("isLoggedIn", "true");
        localStorage.setItem("username", username);

        // Redirect to internal resources page
        window.location.href = `/${lang}/internal`;
      } else {
        // Show error message
        errorMessage?.classList.remove("hidden");

        // Hide error after 3 seconds
        setTimeout(() => {
          errorMessage?.classList.add("hidden");
        }, 3000);
      }
    } catch (error) {
      console.error("Login error:", error);
      errorMessage?.classList.remove("hidden");
      setTimeout(() => {
        errorMessage?.classList.add("hidden");
      }, 3000);
    } finally {
      // Re-enable submit button
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = "Login";
      }
    }
  });
</script>

<style>
  .animate-fade-in {
    animation: fadeIn 0.6s ease-out forwards;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
